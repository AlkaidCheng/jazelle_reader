name: Manual Integration Tests

on:
  workflow_dispatch:
    inputs:
      run_cpp_tests:
        description: 'Run C++ Unit Tests'
        required: true
        default: 'true'
        type: boolean
      run_python_tests:
        description: 'Run Python Integration Tests'
        required: true
        default: 'true'
        type: boolean

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake gcc g++ libhdf5-dev

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install scikit-build-core cython numpy pytest h5py awkward pyarrow

    # --- 1. Fetch Private Data (SECURE STEP) ---
    - name: Fetch Private Jazelle Data
      if: ${{ inputs.run_python_tests }}
      env:
        # Add this secret in GitHub Repo Settings -> Secrets -> Actions
        DATA_URL: ${{ secrets.JAZELLE_DATA_URL }} 
      run: |
        if [ -z "$DATA_URL" ]; then
          echo "Error: JAZELLE_DATA_URL secret is not set."
          exit 1
        fi
        mkdir -p data
        curl -L -o data/test.jazelle "$DATA_URL"
        echo "JAZELLE_TEST_FILE=$(pwd)/data/test.jazelle" >> $GITHUB_ENV

    # --- 2. Build and Test C++ Core ---
    - name: Build C++ Tests
      if: ${{ inputs.run_cpp_tests }}
      run: |
        mkdir build_cpp
        cd build_cpp
        cmake -DBUILD_TESTS=ON ..
        cmake --build . --config Release

    - name: Run C++ Tests
      if: ${{ inputs.run_cpp_tests }}
      cd: build_cpp
      run: ctest --output-on-failure

    # --- 3. Install Python Package ---
    - name: Install Jazelle Package
      run: |
        pip install .

    # --- 4. Run Python Tests ---
    - name: Run Python Integration Tests
      if: ${{ inputs.run_python_tests }}
      run: |
        # The JAZELLE_TEST_FILE env var is already set from step 1
        pytest tests/python/ -v -s
